# PWA Implementation Guide - ProUltima Task Manager

This document explains how our Progressive Web App (PWA) is implemented following the [official Next.js PWA documentation](https://nextjs.org/docs/app/guides/progressive-web-apps).

## 📋 Table of Contents

1. [Overview](#overview)
2. [Manifest Configuration](#manifest-configuration)
3. [Service Worker](#service-worker)
4. [PWA Features](#pwa-features)
5. [Offline Support](#offline-support)
6. [Installation](#installation)
7. [Testing](#testing)
8. [Security](#security)

---

## 🎯 Overview

Our PWA implementation provides:
- ✅ **Offline-first architecture** with IndexedDB
- ✅ **Install to home screen** capability
- ✅ **Service worker** for caching and offline support
- ✅ **Real-time sync** across devices and browsers
- ✅ **Network detection** and automatic reconnection
- ✅ **Push notifications** (ready for implementation)

---

## 📱 Manifest Configuration

### Location: `src/app/manifest.ts`

According to Next.js documentation, the manifest should be in the `app` directory and export a function that returns the manifest object.

```typescript
// src/app/manifest.ts
export default function manifest() {
  return {
    name: "ProUltima Task Manager",
    short_name: "ProUltima",
    description: "Professional task management platform",
    start_url: "/",
    display: "standalone",
    background_color: "#ffffff",
    theme_color: "#667eea",
    orientation: "portrait-primary",
    icons: [
      // Multiple icon sizes for different devices
      {
        src: "/icons/icon-192x192.svg",
        sizes: "192x192",
        type: "image/svg+xml",
        purpose: "maskable"
      },
      {
        src: "/icons/icon-512x512.svg",
        sizes: "512x512",
        type: "image/svg+xml",
        purpose: "maskable"
      }
    ]
  }
}
```

### Key Properties:

- **`name`**: Full application name
- **`short_name`**: Short name for home screen
- **`start_url`**: URL when app launches
- **`display: "standalone"`**: Makes app look like native app
- **`theme_color`**: Browser UI color
- **`icons`**: App icons for different sizes
- **`purpose: "maskable"`**: Allows icons to be masked on Android

---

## 🔧 Service Worker

### Location: `public/sw.js`

Our service worker is auto-generated by `@ducanh2912/next-pwa` and provides:

1. **Precaching**: Static assets are cached on install
2. **Runtime caching**: Dynamic content caching strategies
3. **Offline fallback**: Serves cached content when offline
4. **Background sync**: Queues failed requests for retry

### Caching Strategies:

```javascript
// Network First (for API calls)
- Try network first
- Fall back to cache if network fails
- Update cache with network response

// Cache First (for static assets)
- Serve from cache immediately
- Update cache in background

// Stale While Revalidate (for images)
- Serve cached version immediately
- Fetch fresh version in background
```

### Registration: `src/lib/pwa.ts`

```typescript
export function registerServiceWorker() {
  if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          console.log('SW registered: ', registration);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New version available
                  if (confirm('New version available! Refresh to update?')) {
                    window.location.reload();
                  }
                }
              });
            }
          });
        })
        .catch((error) => {
          console.log('SW registration failed: ', error);
        });
    });
  }
}
```

---

## 🚀 PWA Features

### 1. Install Prompt

**Location**: `src/lib/pwa.ts` - `setupInstallPrompt()`

```typescript
export function setupInstallPrompt() {
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    const promptEvent = e as BeforeInstallPromptEvent;
    
    // Show custom install button
    showInstallPrompt(promptEvent);
  });

  window.addEventListener('appinstalled', () => {
    console.log('PWA was installed');
  });
}
```

**Features**:
- Custom install button appears when app is installable
- Auto-hides after 10 seconds
- Tracks installation success

### 2. Network Detection

**Location**: `src/lib/pwa.ts` - `setupNetworkDetection()`

```typescript
export function setupNetworkDetection() {
  const updateOnlineStatus = () => {
    const status = navigator.onLine ? 'online' : 'offline';
    document.body.setAttribute('data-network', status);
    
    // Dispatch custom event
    window.dispatchEvent(new CustomEvent('network-change', {
      detail: { isOnline: navigator.onLine }
    }));
  };

  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  
  updateOnlineStatus(); // Initial status
}
```

**Features**:
- Real-time network status detection
- Custom events for components to listen
- Visual indicators in UI

### 3. PWA Initializer Component

**Location**: `src/components/pwa-initializer.tsx`

```typescript
'use client';

import { useEffect } from 'react';
import { initializePWA } from '@/lib/pwa';

export function PWAInitializer() {
  useEffect(() => {
    initializePWA();
  }, []);

  return null;
}
```

**Usage in Layout**:
```typescript
// src/app/layout.tsx
export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <PWAInitializer />
        {children}
      </body>
    </html>
  );
}
```

---

## 💾 Offline Support

### IndexedDB with Dexie.js

**Location**: `src/lib/offline/db.ts`

Our offline-first architecture uses IndexedDB to store:
- Staff data
- Tasks
- Teams
- Team members
- Task assignments
- Sync queue

```typescript
export const offlineDB = new Dexie('ProUltimaDB') as Dexie & {
  staff: Table<OfflineStaff>;
  tasks: Table<OfflineTask>;
  teams: Table<OfflineTeam>;
  teamMembers: Table<OfflineTeamMember>;
  taskAssignments: Table<OfflineTaskAssignment>;
  syncQueue: Table<SyncQueueItem>;
};
```

### Hybrid Online/Offline Strategy

**When Online**:
1. Direct operation to Supabase
2. Update IndexedDB for immediate UI update
3. Trigger cross-browser sync
4. Dispatch `dataUpdated` event

**When Offline**:
1. Operation to IndexedDB
2. Queue operation for sync
3. UI updates immediately
4. Auto-sync when connection restored

### Sync Service

**Location**: `src/lib/offline/sync-service.ts`

```typescript
class SyncService {
  // Periodic sync every 30 seconds
  private syncInterval: number = 30000;
  
  // Cross-browser sync via localStorage
  setupCrossBrowserSync() {
    window.addEventListener('storage', (event) => {
      if (event.key === 'pwa-sync-trigger') {
        this.handleCrossBrowserSync();
      }
    });
  }
  
  // Cross-device sync via Supabase Realtime
  setupSupabaseRealtime() {
    const channel = supabase.channel('db-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'staff' }, 
        (payload) => this.handleSupabaseRealtimeChange('staff', payload)
      )
      .subscribe();
  }
}
```

**Features**:
- ✅ Automatic periodic sync (every 30 seconds)
- ✅ Cross-browser sync (same device, different browsers)
- ✅ Cross-device sync (via Supabase Realtime)
- ✅ Conflict resolution
- ✅ Retry failed operations

---

## 📥 Installation

### Requirements (from Next.js docs):

1. ✅ **Valid web app manifest** (`src/app/manifest.ts`)
2. ✅ **HTTPS** (required for service workers)
3. ✅ **Service worker** registered (`public/sw.js`)
4. ✅ **Icons** in multiple sizes (`public/icons/`)

### Installation Methods:

#### Desktop (Chrome/Edge):
1. Visit the app
2. Look for install icon in address bar
3. Click "Install ProUltima"

#### Mobile (Android):
1. Visit the app
2. Tap browser menu (⋮)
3. Select "Add to Home Screen"
4. Confirm installation

#### Mobile (iOS):
1. Visit the app in Safari
2. Tap Share button (□↑)
3. Scroll and tap "Add to Home Screen"
4. Confirm installation

**Note**: iOS has special requirements handled in our layout:

```typescript
// src/app/layout.tsx
export const metadata: Metadata = {
  appleWebApp: {
    capable: true,
    statusBarStyle: "default",
    title: "ProUltima Task Manager",
  },
};
```

---

## 🧪 Testing

### Local Testing (HTTPS Required)

According to Next.js documentation, service workers require HTTPS. To test locally:

```bash
# Start dev server with HTTPS
npm run dev -- --experimental-https

# Or use the standard command (if configured)
npm run dev
```

### Testing Checklist:

- [ ] **Manifest loads**: Check `/manifest.webmanifest`
- [ ] **Service worker registers**: Check DevTools → Application → Service Workers
- [ ] **Install prompt appears**: Wait for `beforeinstallprompt` event
- [ ] **Offline mode works**: 
  1. Open DevTools → Network
  2. Check "Offline"
  3. Reload page - should still work
- [ ] **Caching works**: Check DevTools → Application → Cache Storage
- [ ] **IndexedDB stores data**: Check DevTools → Application → IndexedDB
- [ ] **Network detection works**: Toggle offline/online
- [ ] **Sync works**: Make changes offline, go online, verify sync

### Browser DevTools:

**Chrome/Edge**:
1. Open DevTools (F12)
2. Go to "Application" tab
3. Check:
   - Manifest
   - Service Workers
   - Cache Storage
   - IndexedDB
   - Storage

**Lighthouse Audit**:
1. Open DevTools
2. Go to "Lighthouse" tab
3. Select "Progressive Web App"
4. Click "Generate report"
5. Should score 90+ for PWA

---

## 🔒 Security

### Content Security Policy

**Location**: `next.config.js`

```javascript
module.exports = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
      {
        source: '/sw.js',
        headers: [
          {
            key: 'Content-Type',
            value: 'application/javascript; charset=utf-8',
          },
          {
            key: 'Cache-Control',
            value: 'no-cache, no-store, must-revalidate',
          },
          {
            key: 'Content-Security-Policy',
            value: "default-src 'self'; script-src 'self'",
          },
        ],
      },
    ]
  },
}
```

### Security Features:

1. **HTTPS Only**: Service workers only work over HTTPS
2. **Same-Origin Policy**: Service worker scope limited to origin
3. **CSP Headers**: Prevent XSS and injection attacks
4. **Supabase RLS**: Row-level security on database
5. **No-Cache SW**: Always get latest service worker

---

## 🎨 UI Components

### Sync Status Indicator

**Location**: `src/components/ui/sync-status-indicator.tsx`

Shows real-time sync status:
- 🟢 Online - connected to server
- 🔴 Offline - working locally
- 🔄 Syncing - uploading changes
- ⏱️ Last sync time

### Network Status Badge

Displays current network status and pending operations:
```typescript
<Badge variant="secondary" className="bg-green-100">
  <Wifi className="w-3 h-3 mr-1" />
  Online
</Badge>
```

---

## 📊 Data Flow

### Create/Update/Delete Operations:

```
User Action
    ↓
Check Network Status
    ↓
┌─────────────┬─────────────┐
│   Online    │   Offline   │
├─────────────┼─────────────┤
│ 1. Supabase │ 1. IndexedDB│
│ 2. IndexedDB│ 2. Queue    │
│ 3. UI Update│ 3. UI Update│
│ 4. Sync     │             │
└─────────────┴─────────────┘
    ↓
Dispatch 'dataUpdated' Event
    ↓
React Query Refetch
    ↓
UI Updates Everywhere
```

### Real-time Synchronization:

```
Device A                  Device B
   ↓                         ↓
Change Data              Listening
   ↓                         ↓
Supabase Realtime ────────→ Receive
   ↓                         ↓
Update IndexedDB         Update IndexedDB
   ↓                         ↓
Dispatch Event           Dispatch Event
   ↓                         ↓
UI Updates               UI Updates
```

---

## 🔄 React Query Integration

### Real-time Updates Hook

**Location**: All `use-offline-*.ts` hooks

```typescript
// Listen for data updates
useEffect(() => {
  const handleDataUpdate = () => {
    queryClient.invalidateQueries({ queryKey: ['offline-staff'] });
  };

  window.addEventListener('dataUpdated', handleDataUpdate);
  
  return () => {
    window.removeEventListener('dataUpdated', handleDataUpdate);
  };
}, [queryClient]);
```

### Dashboard Auto-Refresh

**Location**: `src/components/dashboard/dashboard-client.tsx`

```typescript
// Auto-refresh every 5 seconds
useEffect(() => {
  const intervalId = setInterval(() => {
    queryClient.invalidateQueries({ queryKey: ['offline-tasks'] });
    queryClient.invalidateQueries({ queryKey: ['offline-staff'] });
    queryClient.invalidateQueries({ queryKey: ['offline-teams'] });
  }, 5000);

  return () => clearInterval(intervalId);
}, [queryClient]);
```

---

## 📚 Additional Resources

- [Next.js PWA Documentation](https://nextjs.org/docs/app/guides/progressive-web-apps)
- [Web.dev PWA Guide](https://web.dev/progressive-web-apps/)
- [MDN Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [What PWA Can Do Today](https://whatpwacando.today/)
- [Workbox Documentation](https://developers.google.com/web/tools/workbox)

---

## 🎯 Summary

Our PWA implementation follows Next.js best practices and provides:

✅ **Offline-first architecture** - Works without internet
✅ **Real-time sync** - Changes appear instantly across devices
✅ **Install to home screen** - Native app-like experience
✅ **Background sync** - Automatic data synchronization
✅ **Network resilience** - Graceful offline/online transitions
✅ **Security** - HTTPS, CSP headers, RLS policies
✅ **Performance** - Caching strategies for fast loading

The app is production-ready and follows all PWA standards! 🚀

